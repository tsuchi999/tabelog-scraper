from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from bs4 import BeautifulSoup
import os, time, re

# å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹è¨­å®š
output_dir = r"D:\tabelog"
os.makedirs(output_dir, exist_ok=True)
output_txt_file = os.path.join(output_dir, "tabelog_candidates.txt")
output_html_file = os.path.join(output_dir, "tabelog_candidates.html")
exclude_file = os.path.join(output_dir, "exclude_names.txt")
visited_file = os.path.join(output_dir, "visited.txt")

# é™¤å¤–ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
exclude_names = set()
visited_names = set()
if os.path.exists(exclude_file):
    with open(exclude_file, encoding="utf-8") as f:
        exclude_names = set(line.strip() for line in f if line.strip())
if os.path.exists(visited_file):
    with open(visited_file, encoding="utf-8") as f:
        visited_names = set(line.strip() for line in f if line.strip())
excluded = exclude_names.union(visited_names)

# å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åˆæœŸåŒ–ï¼ˆæ¯å›ä¸Šæ›¸ãï¼‰
with open(output_txt_file, "w", encoding="utf-8") as f:
    pass

with open(output_html_file, "w", encoding="utf-8") as f:
    f.write("""<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2025ç™¾ååº—å€™è£œåº—ãƒªã‚¹ãƒˆ</title>
<style>
  body { font-family: sans-serif; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  tr:nth-child(even) { background-color: #f9f9f9; }
  tr:nth-child(odd) { background-color: #ffffff; }
  th { background-color: #e0e0e0; }
</style>
</head>
<body>
<h2>2025ç™¾ååº—å€™è£œåº—ãƒªã‚¹ãƒˆ</h2>
<table>
  <tr><th>é †ä½</th><th>åº—åï¼ˆãƒªãƒ³ã‚¯ï¼‰</th><th>ã‚¹ã‚³ã‚¢</th><th>æœ€å¯„ã‚Šé§…</th><th>ä¼‘æ¥­æ—¥</th></tr>
""")

# Chromeã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
options = Options()
# options.add_argument("--headless")  # ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹åŒ–ã™ã‚‹å ´åˆã¯è§£é™¤
options.add_argument("--disable-blink-features=AutomationControlled")
options.add_experimental_option("excludeSwitches", ["enable-automation"])
options.add_experimental_option("useAutomationExtension", False)
options.add_argument("user-agent=Mozilla/5.0")

# ãƒ‰ãƒ©ã‚¤ãƒèµ·å‹•
driver = webdriver.Chrome(options=options)
driver.execute_cdp_cmd("Page.addScriptToEvaluateOnNewDocument", {
    "source": "Object.defineProperty(navigator, 'webdriver', { get: () => undefined })"
})

# ãƒšãƒ¼ã‚¸ã‚’5ã€œ9ã¾ã§ãƒ«ãƒ¼ãƒ—
for page in range(5, 10):
    print(f"\nğŸ“„ {page}ãƒšãƒ¼ã‚¸ç›® é–‹å§‹")
    driver.get(f"https://tabelog.com/kanagawa/rstLst/ramen/{page}/?Srt=D&SrtT=rt&sk=ãƒ©ãƒ¼ãƒ¡ãƒ³")

    try:
        WebDriverWait(driver, 15).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, "div.list-rst__wrap"))
        )
    except Exception as e:
        print(f"âŒ èª­ã¿è¾¼ã¿NG: {e}")
        with open(os.path.join(output_dir, f"debug_page_{page}.html"), "w", encoding="utf-8") as debug_f:
            debug_f.write(driver.page_source)
        continue

    soup = BeautifulSoup(driver.page_source, "html.parser")
    cards = soup.select("div.list-rst__wrap")
    print(f"ğŸ‘‰ è¦‹ã¤ã‹ã£ãŸ: {len(cards)} åº—èˆ—")

    if len(cards) == 0:
        with open(os.path.join(output_dir, f"debug_page_{page}.html"), "w", encoding="utf-8") as debug_f:
            debug_f.write(driver.page_source)

    with open(output_txt_file, "a", encoding="utf-8") as txt_f, open(output_html_file, "a", encoding="utf-8") as html_f:
        for card in cards:
            name_tag = card.select_one("a.list-rst__rst-name-target")
            score_tag = card.select_one("span.c-rating__val")
            rank_tag = card.select_one("span.c-ranking-badge__no")
            genre_tag = card.select_one("div.list-rst__area-genre")
            holiday_tag = card.select_one("span.list-rst__holiday-text")

            if not name_tag:
                continue

            name = name_tag.get_text(strip=True)
            url = name_tag["href"]
            if name in excluded:
                continue

            score_raw = score_tag.get_text(strip=True) if score_tag else "?"
            score = float(score_raw) if score_raw.replace(".", "", 1).isdigit() else 0
            score_str = f'<span style="color:red">{score_raw}</span>' if score >= 3.62 else score_raw

            rank = rank_tag.get_text(strip=True) if rank_tag else "?"
            closed = holiday_tag.get_text(strip=True) if holiday_tag else ""

            # æœ€å¯„ã‚Šé§… or å¸‚åŒºç”ºæ‘ã‚’æŠ½å‡º
            station = "-"
            if genre_tag:
                area_text = genre_tag.get_text(strip=True)
                if "/" in area_text:
                    station = area_text.split("/")[0].strip()
                else:
                    station = area_text.strip()

            # ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›
            line1 = f"{rank}ã€€{name}ï¼ˆ{score_raw}ï¼‰{station}"
            if closed:
                line1 += f"ã€€ä¼‘ï¼š{closed}"
            print("â†’", line1)
            txt_f.write(line1 + "\n")
            txt_f.write(url + "\n\n")

            # HTMLå‡ºåŠ›ï¼ˆãƒªãƒ³ã‚¯ä»˜ãåº—åï¼‹ã‚¹ã‚³ã‚¢ã«è‰²ï¼‰
            html_f.write(f"""  <tr>
    <td>{rank}</td>
    <td><a href="{url}" target="_blank">{name}</a></td>
    <td>{score_str}</td>
    <td>{station}</td>
    <td>{closed}</td>
  </tr>
""")

    time.sleep(2)

# HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ç· ã‚ã‚¿ã‚°
with open(output_html_file, "a", encoding="utf-8") as f:
    f.write("""
</table>
</body>
</html>
""")

driver.quit()
print("\nâœ… å®Œäº†ï¼txtã‚‚htmlã‚‚å‡ºåŠ›OKã€ãƒªãƒ³ã‚¯ã‚‚è‰²åˆ†ã‘ã‚‚å®Œç’§ã‚„ã§âœ¨")
